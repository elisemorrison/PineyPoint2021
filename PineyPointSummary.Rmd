---
title: "UF - Morrison Lab Preliminary Piney Point Results"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

Preliminary analysis of results from NSF RAPID project on tracking the effects of Piney Point discharge on Tampa Bay. Sites throughout Tampa Bay and St. Joseph Sound were sampled at minimum every two weeks. 

```{r setup, include=FALSE, echo=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(cowplot)
library(knitr)

knitr::opts_chunk$set(echo = TRUE)


```

## Bulk Particulate Organic Matter (POM)
```{r, include=FALSE, echo=FALSE}
raw_POM<-readxl::read_excel("../Data/UF_SIL/Full_PP_GFF_data.xlsx", sheet = 1)


noNA_date<-raw_POM[!is.na(raw_POM$Date), ]  
noNA_date$`wt %N`<-as.numeric(noNA_date$`wt %N`)
noNA_date$`wt %C`<-as.numeric(noNA_date$`wt %C`)

noNA_date<-mutate(noNA_date, CN=`wt %C`/`wt %N`)
#noNA_onlysites<-filter(noNA_date, Location!=("Blank")&Location!=("Effluent"))
#effluent<-filter(noNA_date, grepl("filter_pineypoint3", GFF_ID))


```


### d13C for all locations and sampling dates for POM
```{r, echo=FALSE, warning=FALSE}
eff_d13C<-ggplot(effluent, aes(Location, `d13C (permil, vs VPDB)`))+
  geom_point()+
  scale_y_continuous(limits = c(-31, -15))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

POM_d13C<-ggplot(noNA_onlysites, aes(Date, `d13C (permil, vs VPDB)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

plot_grid(POM_d13C, eff_d13C, rel_widths = c(1, 0.25))
```



<!---Figure 1. Changes in d13C values for particulate organic matter (POM) over time. There is a clear enrichment of d13C values over the course of the study period.

Extra notes: Protein/carbohydrates higher/more enriched d13C value, lipids/lignin lower/depleted(more negative) value. OM decomposition selectively removes labile 13C depleting d13C. Photosynthetic carbon (d13C -27permil), atmospheric C (d13C -7permil). Photosynthetic biomass enriched, since dissolved CO2 or HCO3- is used for C fixation(d13C = 0permil). C4 plants more enriched (d13C values between 8-18permil), Algae pump either CO2 or HCO3 as a C source for photosynthesis (d13C = 0), while land plants use CO2 from atmosphere (d13C= -7permil), so algae have more enriched signature. (From Bianchi and Canuel, 2011). Effluent POM could be a combination of C4 plants (-16 to -9 permil; Sharp 2017), higher plants (-11.54 to -13.21permil, Homosassa to Wacassasa; Barry et al., 2018), algae -23.4permil; sediment (-16.14 to -19.86), seagrass leaf d13C was between -12 and -5permil.

Lyngbya: d13C
-->


### d15N for all locations and sampling dates for POM
```{r, echo=FALSE, warning=FALSE}

eff_d15N<-ggplot(effluent, aes(Location, `d15N (permil, vs AIR)`))+
  geom_point()+
  scale_y_continuous(limits = c(-18, 4))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

POM_d15N<-ggplot(noNA_onlysites, aes(Date, `d15N (permil, vs AIR)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

plot_grid(POM_d15N, eff_d15N, rel_widths = c(1, 0.25))
```
<!---Figure 2. POM d15N values. 

Extra notes: Inorganic N species can have wide range of d15N values. d15N enriched 2 to 3 permil with each trophic level (Bianchi and Canuel, 2011). From Sharp (2017) average value of N fixation is less than 0permil. From Sharp 2017/Velinsky et al (1991), waters with NH4+ of 40uM, fractionation between POM and NH4 modeled to be -20 to -30permil. with lower concentrations, 9uM fractionations were -15 to -15permil. **Effluent had a NH4-N concentration of 61.6 uM.** Ammonium is lighter than nitrate by several per mil. Peterson and Fry's average estimate for precip are -18 to 8 for ammonium and -15 to 3 permil for NO3-. d15N values from most ocean materials are positive. 
-->

### C:N for all locations and sampling dates for POM
```{r, echo=FALSE, warning=FALSE}

eff_CN<-ggplot(effluent, aes(Location, CN))+
  geom_point()+
  scale_y_continuous(limits = c(3, 13))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

POM_CN<-ggplot(noNA_onlysites, aes(Date, CN))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

plot_grid(POM_CN, eff_CN, rel_widths = c(1, 0.25))
```

### %TN for all locations and sampling dates for POM
```{r, echo=FALSE, warning=FALSE}

eff_TN<-ggplot(effluent, aes(Location, `wt %N`))+
  geom_point()+
  scale_y_continuous(limits = c(0, 3))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

POM_TN<-ggplot(noNA_onlysites, aes(Date, `wt %N`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

plot_grid(POM_TN, eff_TN, rel_widths = c(1, 0.25))
```

### %TC for all locations and sampling dates for POM
```{r, echo=FALSE, warning=FALSE}

eff_TC<-ggplot(effluent, aes(Location, `wt %C`))+
  geom_point()+
  scale_y_continuous(limits = c(1, 12))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

POM_TC<-ggplot(noNA_onlysites, aes(Date, `wt %C`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

plot_grid(POM_TC, eff_TC, rel_widths = c(1, 0.25))
```
Explore variablity in St. Joseph sound data
Appears to be related to the site location, SSJS3 is the northernmost site

```{r, echo=FALSE, warning=FALSE, include=FALSE}
#variability in St Joseph sound, so see if it's variability for each transect

StJoe<-filter(noNA_onlysites, Location=="St. Joseph Sound")

ggplot(StJoe, aes(Date, `wt %C`))+
  geom_point()+
  facet_wrap(.~Site)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")


ggplot(StJoe, aes(Date, `d13C (permil, vs VPDB)`))+
  geom_point()+
  facet_wrap(.~Site)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

ggplot(StJoe, aes(Date, `wt %N`))+
  geom_point()+
  facet_wrap(.~Site)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

ggplot(StJoe, aes(Date, `wt %N`))+
  geom_point()+
  facet_wrap(.~Site)+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")

```

```{r, include=FALSE, echo=FALSE}
###extra code for shading dates, not used yet
 # geom_rect(data = data.frame(xmin = decimal_date(as.Date(c("1924-01-01"))),
 #                              xmax = decimal_date(as.Date(c("1928-12-31"))),
 #                              ymin = -Inf,
 #                              ymax = Inf),
 #            aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
 #            fill = "grey", alpha = 0.5)

```

## Nutrient data
```{r, echo=FALSE, warning=FALSE, include=FALSE}

nutrients_raw<-readxl::read_excel("../Data/PineyPoint_all_samples_w_data.xlsx")

nutrients_raw$`OrthoP (ug/L)`<-as.numeric(nutrients_raw$`OrthoP (ug/L)`)
nutrients_raw$`Salinity (ppt)`<-as.numeric(nutrients_raw$`Salinity (ppt)`)

#nutrients_onlysites<-filter(nutrients_raw, Location!=("Blank")&Location!=("Effluent"))
#nutrients_effluent<-filter(nutrients_raw, Location==("Effluent"))


```

### Orthophosphate
```{r, echo=FALSE, warning=FALSE}

eff_orthoP<-ggplot(nutrients_effluent, aes(Location, `OrthoP (ug/L)`))+
  geom_point()+
  scale_y_continuous(limits = c(0, 170000))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

orthoP<-ggplot(nutrients_onlysites, aes(`Date of Sample collection`, `OrthoP (ug/L)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")

plot_grid(orthoP, eff_orthoP, rel_widths = c(1, 0.25))
```

### Total phosphorus
```{r, echo=FALSE, warning=FALSE}

eff_TP<-ggplot(nutrients_effluent, aes(Location, `TotalP (ug/L)`))+
  geom_point()+
  scale_y_continuous(limits = c(0, 170000))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

TP<-ggplot(nutrients_onlysites, aes(`Date of Sample collection`, `TotalP (ug/L)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")

plot_grid(TP, eff_TP, rel_widths = c(1, 0.25))
```

### TKN
```{r, echo=FALSE, warning=FALSE}
TKN<-ggplot(nutrients_onlysites, aes(`Date of Sample collection`, `TKN (mg/L)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")

plot_grid(TKN, eff_TP, rel_widths = c(1, 0.25))
```

### NH4-N
```{r, echo=FALSE, warning=FALSE}

eff_NH4<-ggplot(nutrients_effluent, aes(Location, `NH4N (mg/L)`))+
  geom_point()+
  scale_y_continuous(limits = c(0, 2))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

nutrients_onlysites_greater0_NH4<-filter(nutrients_onlysites, `NH4N (mg/L)`>0)

NH4<-ggplot(nutrients_onlysites_greater0_NH4, aes(`Date of Sample collection`, `NH4N (mg/L)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")

plot_grid(NH4, eff_NH4, rel_widths = c(1, 0.25))
```

### NOx
```{r, echo=FALSE, warning=FALSE}

eff_NOx<-ggplot(nutrients_effluent, aes(Location, `NOx (mg/L)`))+
  geom_point()+
  scale_y_continuous(limits = c(0, 1))+
  theme_cowplot(font_size = 8)+
   panel_border(color="black")+
  xlab("")

#remove values <0, because below LOD
NOx_data<-filter(nutrients_onlysites, `NOx (mg/L)`>0)

NOx<-ggplot(NOx_data, aes(`Date of Sample collection`, `NOx (mg/L)`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")

plot_grid(NOx, eff_NOx, rel_widths = c(1, 0.25))
```

```{r, echo=FALSE, warning=FALSE}

chl<-ggplot(nutrients_onlysites, aes(`Date of Sample collection`, `Total Chl`))+
  geom_point()+
  facet_wrap(.~Location)+
  theme_cowplot(font_size = 8)+
  panel_border(color="black")+
  ylab("Total chlorophyll (ug/L)")

chl
```

```{r, echo=FALSE}
#nozeros<-filter(nutrients_onlysites, `NH4N (mg/L)`>0 & `NOx (mg/L)`>0)

#withPOM<-full_join(nozeros, noNA_onlysites)

all_data_w_eff<-full_join(noNA_date, nutrients_raw)
#### TODO: need to fix the name of the date columns - they currently don't match and are causing issues
```

## Test plots to look at relationships between variables
```{r, echo=FALSE}
ggplot(withPOM, aes(`CN`, 
                     `d15N (permil, vs AIR)`))+
  geom_point()+
  geom_smooth()

ggplot(withPOM, aes(`wt %C`, 
                     `d15N (permil, vs AIR)`))+
  geom_point(aes(color=`Location`))+
  geom_smooth()

ggplot(withPOM, aes(`wt %N`, 
                     `d15N (permil, vs AIR)`))+
  geom_point(aes(color=`Location`))+
  geom_smooth()

### look for conservative behavior in ortho-P, TP, TKN, NH4

ggplot(withPOM, aes(`Salinity (ppt)`, 
                     `d15N (permil, vs AIR)`))+
  geom_point(aes(color=`Location`))+
  geom_smooth(method = "lm")

ggplot(withPOM, aes(`Salinity (ppt)`, 
                     `OrthoP (umol/L)`))+
  geom_point(aes(color=`Location`))+
  geom_smooth(method = "lm")


```


### Phytoplankton community data

```{r, echo=FALSE}

## received phytoplankton community data from the priority sites, since 4/2021, from E. Phlips. Have one file with biovolume and biomass, and another for phytoplankton biomass by group

#first look at the simpler dataset, phytoplankton biomass by group in ug C/ml

bygroup<-read_excel("../Data/Phlips/Piney Point Phyto by group carbon 09 15 2021 draft.xlsx", sheet = 1, skip=1)
#skip the first row, which just says "phytoplankton biomass by group in ug C/ml", so we can keep column headers

#column 8 was also left blank, remove
bygroup<-bygroup[,-8]

#rename column names: Site, should be SampleID to match WQ data
#rename DATE to Date of sample collection
bygroup_renamed<-rename(bygroup, `Date of Sample collection`=DATE)
bygroup_renamed<-rename(bygroup_renamed, SampleID=SITE)

## there are some inconsistencies between the Phlip's lab site IDs and the water sample IDs
## its mostly related to cases, although the first batch of samples 1-4 were labeled 1Y-4Y for water samples, 1X-4X for phyto samples
## make sampleIDs consistent

bygroup_renamed<-mutate_if(bygroup_renamed,
                            is.character,
                            str_replace_all, pattern = "x", replacement = "Y") %>% 
                  mutate_if(is.character,
                            str_replace_all, pattern="BHSONDE", replacement="BH Sonde") %>% 
                  mutate_if(is.character,
                            str_replace_all,  pattern="JBYSI", replacement="JB Sonde") %>% 
                  mutate_if(is.character,
                            str_replace_all,  pattern="JB6", replacement="JB-6") %>% 
                  mutate_if(is.character,
                            str_replace_all, pattern="JBSONDE", replacement="JB Sonde") %>% 
                  mutate_if(is.character,
                            str_replace_all, pattern="PPEFFL", replacement="Piney Point Effluent") %>% 
                  mutate_if(is.character,
                            str_replace_all, pattern="PPSONDE", replacement="PP Sonde") %>% 
                  mutate_if(is.character,
                            str_replace_all, pattern="SSJSSOND", replacement="SSJS Sonde")



all_data_w_eff<-mutate_if(all_data_w_eff, 
                          is.character, 
                          str_replace_all, pattern="SSJS sonde", replacement="SSJS Sonde") %>% 
                mutate_if(is.character, 
                          str_replace_all, pattern="JBYSI (Joe Bay)", replacement="JB Sonde")



##join with the water chem data by date and site
chem_phyto<-full_join(bygroup_renamed, all_data_w_eff)


```

```{r, echo=FALSE}
ggplot(chem_phyto, aes('TotalP (ug/L)', Karenia))+
  geom_point()

```
